{% extends "frontend/base.html" %}

{% block title %}{{ _("Home") }} – Blogy{% endblock %}

{% block content %}
<!-- Blog Hero Section -->
<section id="blog-hero" class="blog-hero section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="blog-grid" id="hero-grid"></div>
  </div>
</section>
<!-- /Blog Hero Section -->

<!-- Featured Posts Section -->
<section id="featured-posts" class="featured-posts section">
  <!-- Section Title -->
  <div class="container section-title" data-aos="fade-up">
    <h2>{{ _("Featured Posts") }}</h2>
    <div>
      <span>{{ _("Check Our") }}</span>
      <span class="description-title">{{ _("Featured Posts") }}</span>
    </div>
  </div>
  <!-- End Section Title -->

  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="blog-posts-slider swiper init-swiper">
      <script type="application/json" class="swiper-config">
        {
          "loop": true,
          "speed": 800,
          "autoplay": {
            "delay": 5000
          },
          "slidesPerView": 3,
          "spaceBetween": 30,
          "breakpoints": {
            "320": {
              "slidesPerView": 1,
              "spaceBetween": 20
            },
            "768": {
              "slidesPerView": 2,
              "spaceBetween": 20
            },
            "1200": {
              "slidesPerView": 3,
              "spaceBetween": 30
            }
          }
        }
      </script>
      <div class="swiper-wrapper" id="featured-wrapper"></div>
    </div>
  </div>
</section>
<!-- /Featured Posts Section -->

<!-- Category Section Section -->
<section id="category-section" class="category-section section">
  <!-- Section Title -->
  <div class="container section-title" data-aos="fade-up">
    <h2>{{ _("Category Section") }}</h2>
    <div><span class="description-title">{{ _("Category Section") }}</span></div>
  </div>
  <!-- End Section Title -->

  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="row gy-4 mb-4" id="category-featured"></div>
    <div class="row" id="category-list"></div>
  </div>
</section>
<!-- /Category Section Section -->

<!-- Call To Action 2 Section -->
<section id="call-to-action-2" class="call-to-action-2 section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div
      class="advertise-1 d-flex flex-column flex-lg-row gap-4 align-items-center position-relative"
    >
      <div
        class="content-left flex-grow-1"
        data-aos="fade-right"
        data-aos-delay="200"
      >
        <span class="badge text-uppercase mb-2">{{ _("Don't Miss") }}</span>
        <h2>{{ _("Revolutionize Your Digital Experience Today") }}</h2>
        <p class="my-4">
          {{ _("Strategia accelerates your business growth through innovative solutions and cutting-edge technology. Join thousands of satisfied customers who have transformed their operations.") }}
        </p>
        <div class="features d-flex flex-wrap gap-3 mb-4">
          <div class="feature-item">
            <i class="bi bi-check-circle-fill"></i>
            <span>{{ _("Premium Support") }}</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-check-circle-fill"></i>
            <span>{{ _("Cloud Integration") }}</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-check-circle-fill"></i>
            <span>{{ _("Real-time Analytics") }}</span>
          </div>
        </div>
        <div class="cta-buttons d-flex flex-wrap gap-3">
          <a href="#" class="btn btn-primary">{{ _("Start Free Trial") }}</a>
          <a href="#" class="btn btn-outline">{{ _("Learn More") }}</a>
        </div>
      </div>
      <div
        class="content-right position-relative"
        data-aos="fade-left"
        data-aos-delay="300"
      >
        <img
          src="{{ url_for('static', path='assets/img/misc/misc-1.webp') }}"
          alt="{{ _("Digital Platform") }}"
          class="img-fluid rounded-4"
        />
        <div class="floating-card">
          <div class="card-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="card-content">
            <span class="stats-number">245%</span>
            <span class="stats-text">{{ _("Growth Rate") }}</span>
          </div>
        </div>
      </div>
      <div class="decoration">
        <div class="circle-1"></div>
        <div class="circle-2"></div>
      </div>
    </div>
  </div>
</section>
<!-- /Call To Action 2 Section -->

<!-- Latest Posts Section -->
<section id="latest-posts" class="latest-posts section">
  <!-- Section Title -->
  <div class="container section-title" data-aos="fade-up">
    <h2>{{ _("Latest Posts") }}</h2>
    <div>
      <span>{{ _("Check Our") }}</span>
      <span class="description-title">{{ _("Latest Posts") }}</span>
    </div>
  </div>
  <!-- End Section Title -->

  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="row gy-4" id="latest-wrapper">
      <!-- JS will inject 6 .col-lg-4 cards here -->
    </div>
  </div>
</section>
<!-- /Latest Posts Section -->

<!-- Call To Action Section -->
<section id="call-to-action" class="call-to-action section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="row gy-4 justify-content-between align-items-center">
      <div class="col-lg-6">
        <div class="cta-content" data-aos="fade-up" data-aos-delay="200">
          <h2>{{ _("Subscribe to our newsletter") }}</h2>
          <p>
            Proin eget tortor risus. Mauris blandit aliquet elit, eget tincidunt nibh pulvinar a. Curabitur aliquet quam id dui posuere blandit.
          </p>
          <form
            action="forms/newsletter.php"
            method="post"
            class="php-email-form cta-form"
            data-aos="fade-up"
            data-aos-delay="300"
          >
            <div class="input-group mb-3">
              <input
                type="email"
                class="form-control"
                placeholder="{{ _('Email address') }}..."
                aria-label="{{ _('Email address') }}..."
                aria-describedby="button-subscribe"
              />
              <button
                class="btn btn-primary"
                type="submit"
                id="button-subscribe"
              >
                {{ _("Subscribe") }}
              </button>
            </div>
            <div class="loading">{{ _("Loading") }}</div>
            <div class="error-message"></div>
            <div class="sent-message">{{ _("Your subscription request has been sent. Thank you!") }}</div>
          </form>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="cta-image" data-aos="zoom-out" data-aos-delay="200">
          <img
            src="{{ url_for('static', path='assets/img/cta/cta-1.webp') }}"
            alt="{{ _('Call to action image') }}"
            class="img-fluid"
          />
        </div>
      </div>
    </div>
  </div>
</section>
<!-- /Call To Action Section -->
{% endblock %}

{% block tail %}
<script>
  const lang = "{{ request.state.language }}";

  // 1) Hero Section
  (async () => {
    try {
      const res   = await fetch(`${window.API_BASE}/api/v1/blogs?size=5&ordering=-published_at`);
      const page  = await res.json();
      const posts = page.items;
      const grid  = document.getElementById("hero-grid");

      if (!posts.length) {
        grid.innerHTML = "<p>{{ _('No posts available.') }}</p>";
        return;
      }

      // Featured card
      const feat = posts[0];
      grid.insertAdjacentHTML("beforeend", `
        <article class="blog-item featured" data-aos="fade-up">
          <img src="${feat.cover_image}" alt="${feat.title}" class="img-fluid"/>
          <div class="blog-content">
            <div class="post-meta">
              <span class="date">${new Date(feat.published_at)
                .toLocaleDateString(lang,{ month:'short',day:'numeric',year:'numeric' })}</span>
              <span class="category">${feat.categories?.[0]?.name||""}</span>
            </div>
            <h2 class="post-title">
              <a href="/blogs/${feat.slug}">${feat.title}</a>
            </h2>
          </div>
        </article>
      `);

      // Next 4 cards
      posts.slice(1).forEach((post, idx) => {
        grid.insertAdjacentHTML("beforeend", `
          <article class="blog-item" data-aos="fade-up" data-aos-delay="${(idx+1)*100}">
            <img src="${post.cover_image}" alt="${post.title}" class="img-fluid"/>
            <div class="blog-content">
              <div class="post-meta">
                <span class="date">${new Date(post.published_at)
                  .toLocaleDateString(lang,{ month:'short',day:'numeric',year:'numeric' })}</span>
                <span class="category">${post.categories?.[0]?.name||""}</span>
              </div>
              <h3 class="post-title">
                <a href="/blogs/${post.slug}">${post.title}</a>
              </h3>
            </div>
          </article>
        `);
      });

      if (window.AOS) window.AOS.refresh();
    } catch (err) {
      console.error("Hero load error:", err);
      document.getElementById("hero-grid").innerHTML =
        `<p class="text-danger text-center">{{ _('Failed to load posts.') }}</p>`;
    }
  })();

  // 2) Featured Posts Section
  (async () => {
    try {
      const res   = await fetch(`${window.API_BASE}/api/v1/blogs?size=5&ordering=-published_at`);
      const page  = await res.json();
      const posts = page.items;
      const wrapper = document.getElementById("featured-wrapper");

      if (!posts.length) {
        wrapper.innerHTML = "<p>{{ _('No featured posts.') }}</p>";
        return;
      }

      posts.forEach(post => {
        const date = new Date(post.published_at)
          .toLocaleDateString(lang,{ year:'numeric',month:'short',day:'numeric' });
        wrapper.insertAdjacentHTML("beforeend", `
          <div class="swiper-slide">
            <div class="blog-post-item">
              <img src="${post.cover_image}" alt="${post.title}" class="img-fluid"/>
              <div class="blog-post-content">
                <div class="post-meta">
                  <span><i class="bi bi-person"></i> ${post.author?.first_name||""}</span>
                  <span><i class="bi bi-clock"></i> ${date}</span>
                  <span><i class="bi bi-chat-dots"></i> ${post.comments_count} {{ _('Comments') }}</span>
                </div>
                <h2><a href="/blogs/${post.slug}">${post.title}</a></h2>
                <p>${(post.content||"").replace(/(<([^>]+)>)/gi,"").slice(0,100)}…</p>
                <a href="/blogs/${post.slug}" class="read-more">
                  {{ _('Read More') }} <i class="bi bi-arrow-right"></i>
                </a>
              </div>
            </div>
          </div>
        `);
      });

      if (window.AOS) window.AOS.refresh();
    } catch (err) {
      console.error("Featured load error:", err);
      document.getElementById("featured-wrapper").innerHTML =
        `<p class="text-danger text-center">{{ _('Failed to load featured posts.') }}</p>`;
    }
  })();

  // 3) Category Section
  (async () => {
    try {
      const categoryIds = [
        "0a1b85b1-7a4d-46d3-85f8-268c71e0f8f7",
        "9adc3b00-986a-403b-a139-379da2f99a8c",
        "b77f79d1-5d7c-4434-805c-41350f8c0da0",
      ];
      const featuredRow = document.getElementById("category-featured");
      const listRow     = document.getElementById("category-list");

      for (const catId of categoryIds) {
        const res  = await fetch(`${window.API_BASE}/api/v1/blogs?category_id=${catId}&size=3&ordering=-published_at`);
        const page = await res.json();
        const items = page.items;
        if (!items.length) continue;

        // Big featured
        const feat = items[0];
        const featDate = new Date(feat.published_at)
          .toLocaleDateString(lang, { year:'numeric', month:'long', day:'numeric' });
        featuredRow.insertAdjacentHTML("beforeend", `
          <div class="col-lg-4">
            <article class="featured-post">
              <div class="post-img">
                <img src="${feat.cover_image}" alt="${feat.title}" class="img-fluid" loading="lazy"/>
              </div>
              <div class="post-content">
                <div class="category-meta">
                  <span class="post-category">${feat.categories?.[0]?.name||""}</span>
                  <div class="author-meta">
                    <span class="post-date">${featDate}</span>
                  </div>
                </div>
                <h2 class="title">
                  <a href="/blogs/${feat.slug}">${feat.title}</a>
                </h2>
              </div>
            </article>
          </div>
        `);

        // Two list posts
        items.slice(1,3).forEach(post => {
          const postDate = new Date(post.published_at)
            .toLocaleDateString(lang, { year:'numeric', month:'long', day:'numeric' });
          listRow.insertAdjacentHTML("beforeend", `
            <div class="col-xl-4 col-lg-6">
              <article class="list-post">
                <div class="post-img">
                  <img src="${post.cover_image}" alt="${post.title}" class="img-fluid" loading="lazy"/>
                </div>
                <div class="post-content">
                  <div class="category-meta">
                    <span class="post-category">${post.categories?.[0]?.name||""}</span>
                  </div>
                  <h3 class="title">
                    <a href="/blogs/${post.slug}">${post.title}</a>
                  </h3>
                  <div class="post-meta">
                    <span class="read-time">${Math.ceil((post.content||"").length/200)} {{ _('mins read') }}</span>
                    <span class="post-date">${postDate}</span>
                  </div>
                </div>
              </article>
            </div>
          `);
        });
      }

      if (window.AOS) window.AOS.refresh();
    } catch (err) {
      console.error("Category load error:", err);
      document.getElementById("category-featured").innerHTML =
        `<p class="text-danger text-center">{{ _('Failed to load category posts.') }}</p>`;
    }
  })();

  // 4) Latest Posts Section
  (async () => {
    try {
      const res   = await fetch(`${window.API_BASE}/api/v1/blogs?size=6&ordering=-published_at`);
      const page  = await res.json();
      const posts = page.items;
      const wrapper = document.getElementById("latest-wrapper");

      if (!posts.length) {
        wrapper.innerHTML = `<p class="text-center text-danger">{{ _('No posts available.') }}</p>`;
        return;
      }

      posts.forEach(post => {
        const date = new Date(post.published_at)
          .toLocaleDateString(lang, { year:'numeric', month:'short', day:'numeric' });
        const name = post.author
          ? `${post.author.first_name||""} ${post.author.last_name||""}`.trim()
          : "";
        const img  = post.author?.avatar || "";

        wrapper.insertAdjacentHTML("beforeend", `
          <div class="col-lg-4">
            <article class="card h-100">
              <img src="${post.cover_image}" class="card-img-top" alt="${post.title}">
              <div class="card-body d-flex flex-column">
                <p class="post-category text-muted mb-1">${post.categories?.[0]?.name||""}</p>
                <h5 class="card-title mb-2">
                  <a href="/blogs/${post.slug}" class="stretched-link text-decoration-none">${post.title}</a>
                </h5>
              </div>
            </article>
          </div>
        `);
      });

      if (window.AOS) window.AOS.refresh();
    } catch (err) {
      console.error("Latest load error:", err);
      document.getElementById("latest-wrapper").innerHTML =
        `<p class="text-center text-danger">{{ _('Failed to load latest posts.') }}</p>`;
    }
  })();
</script>
{% endblock %}
